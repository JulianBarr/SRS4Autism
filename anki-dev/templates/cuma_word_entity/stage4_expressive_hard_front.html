<!-- Hidden data elements -->
<div id="data-word" class="hidden-data">{{Word}}</div>
<div id="data-category" class="hidden-data">{{Category}}</div>
<div id="data-uuid" class="hidden-data">{{UUID}}</div>
<!-- Clean Architecture: Separate Audio and Picture Fields -->
<div id="data-audio" style="display:none;">{{WordAudio}}</div>
<div id="data-picture" style="display:none;">{{WordPicture}}</div>

<div class="cuma-word-card">
  <div class="media-container">
    <div id="media-display"></div>
  </div>
  
  <div class="options-grid-6" id="options-container">
    <p class="loading-text">Loading...</p>
  </div>
</div>

<!-- Visual Console (Hidden by default, can be enabled for debugging) -->
<div id="visual-console">DEBUG LOG:<br></div>

<script>
(function() {
    var consoleDiv = document.getElementById('visual-console');
    window.visualLog = function(msg) {
        console.log(msg);
        if (consoleDiv) consoleDiv.innerHTML += msg + "<br>";
    };
    window.onerror = function(msg, url, line) {
        window.visualLog("üî• GLOBAL ERROR: " + msg + " (Line " + line + ")");
        return false; 
    };
    window.visualLog("‚úÖ Logger Ready (Global Catcher Active)");
})();
</script>

<script>
(function() {
  window.visualLog("üöÄ Script Starting (Stage 4 - Stealth Mode)...");

  function loadDataScript() {
      window.visualLog("Attempting to load _cuma_logic_city_data.js...");
      var s = document.createElement('script');
      s.src = '_cuma_logic_city_data.js';
      s.onload = function() { 
          window.visualLog("‚úÖ Data File Loaded!"); 
          initCard(); 
      };
      s.onerror = function() { 
          window.visualLog("‚ùå Failed to load data file. Check collection.media."); 
          document.getElementById('options-container').textContent = "Error: Data file missing.";
      };
      document.body.appendChild(s);
  }

  function playAudio(filename) {
      if (!filename) return;
      try { 
          var audio = new Audio(filename);
          audio.play().catch(function(e){ window.visualLog("Audio Play Error: "+e); }); 
      } 
      catch(e){ window.visualLog("Audio Error: "+e); }
  }

  function initCard() {
      try {
          window.visualLog("Initializing Card Logic...");
          
          var wordEl = document.getElementById('data-word');
          var audioEl = document.getElementById('data-audio');
          var pictureEl = document.getElementById('data-picture');
          var categoryEl = document.getElementById('data-category');
          var container = document.getElementById('options-container');
          var mediaDisplay = document.getElementById('media-display');
          
          if (!wordEl || !container || !mediaDisplay) throw new Error("Critical elements missing");

          // Clean Architecture: Get data directly from separate fields
          var audioFilename = audioEl ? audioEl.innerText.trim() : null;
          var pictureHTML = pictureEl ? pictureEl.innerHTML.trim() : '';
          
          window.visualLog("Audio: " + (audioFilename || "None"));
          window.visualLog("Picture: " + (pictureHTML ? "Found" : "None"));

          // STAGE 4 (Pic Only): Show picture immediately. Audio only on correct answer.
          if (pictureHTML) {
              mediaDisplay.innerHTML = pictureHTML;
          } else {
              window.visualLog("No image found.");
          }
          
          // Store audioFilename for use in button click handler
          // No auto-play here!

          if (typeof window.CUMA_DATA === 'undefined') {
              window.visualLog("‚ùå window.CUMA_DATA is undefined.");
              return;
          }

          var targetWord = wordEl.innerText.trim();
          var category = categoryEl ? categoryEl.innerText.trim() : '';
          var seedString = document.getElementById('data-uuid').innerText.trim() || targetWord;
          
          var seed = 0;
          for (var i = 0; i < seedString.length; i++) {
              seed = (seed + seedString.charCodeAt(i)) % 100000;
          }
          var seededRandom = function() { 
              var x = Math.sin(seed++) * 10000; 
              return x - Math.floor(x); 
          };

          var data = window.CUMA_DATA;
          var count = 5;
          var sameCount = Math.floor(count / 2);
          
          var selected = [];
          var used = {};
          used[targetWord] = true;

          if (category && data[category]) {
             var same = data[category].filter(function(w) { return !used[w]; });
             for (var k = same.length - 1; k > 0; k--) {
                  var j = Math.floor(seededRandom() * (k + 1));
                  var temp = same[k];
                  same[k] = same[j];
                  same[j] = temp;
             }
             var toAdd = same.slice(0, sameCount);
             selected = selected.concat(toAdd);
             for(var u=0; u<toAdd.length; u++) used[toAdd[u]] = true;
          }

          var all = data.all_words || [];
          all = all.filter(function(w) { return !used[w]; });
          for (var k = all.length - 1; k > 0; k--) {
              var j = Math.floor(seededRandom() * (k + 1));
              var temp = all[k];
              all[k] = all[j];
              all[j] = temp;
          }
          
          var needed = count - selected.length;
          selected = selected.concat(all.slice(0, needed));

          var options = [{w: targetWord, c: true}];
          for(var d=0; d<selected.length; d++) {
              options.push({w: selected[d], c: false});
          }

          for (var k = options.length - 1; k > 0; k--) {
              var j = Math.floor(seededRandom() * (k + 1));
              var temp = options[k];
              options[k] = options[j];
              options[j] = temp;
          }

          container.innerHTML = '';
          for (var m = 0; m < options.length; m++) {
              (function(opt) {
                  var btn = document.createElement('button');
                  btn.className = 'word-option';
                  btn.textContent = opt.w;
                  btn.onclick = function() {
                      if (opt.c) {
                          this.classList.add('selected');
                          if (audioFilename) playAudio(audioFilename); 
                          if (typeof pycmd !== 'undefined') pycmd('ans');
                      } else {
                          this.classList.add('wrong');
                      }
                  };
                  container.appendChild(btn);
              })(options[m]);
          }
          window.visualLog("‚úÖ UI Rendered Successfully");

      } catch (e) {
          window.visualLog("CRASH: " + e.message);
          console.error(e);
      }
  }

  if (typeof window.CUMA_DATA !== 'undefined') {
      window.visualLog("Data already loaded.");
      initCard();
  } else {
      loadDataScript();
  }

})();
</script>
