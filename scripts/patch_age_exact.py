import os
import difflib
from rdflib import Graph, Literal, Namespace
from rdflib.namespace import RDF, RDFS

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
QUEST_TTL_PATH = os.path.join(BASE_DIR, "knowledge_graph", "quest_full.ttl")
ECTA_KG = Namespace("http://ecta.ai/schema/")

# ==========================================
# ç»ˆæå…¨ä¹¦ç›®å½•åŸºå‡†çœŸç›¸ (The Ultimate Ground Truth)
# è¦†ç›– è®¤çŸ¥ã€è¯­è¨€è¡¨è¾¾ã€è¯­è¨€ç†è§£ã€å°è‚Œè‚‰ã€å¤§è‚Œè‚‰ã€æ¨¡ä»¿ å…­å¤§é¢†åŸŸ
# ==========================================
TOC_DATA = [
    # ---------------- è®¤çŸ¥å‘å±•ç¯‡ ----------------
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-12ä¸ªæœˆ", "å­¦ä¹ æ§åˆ¶è‡ªå·±çš„èº«ä½“"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-12ä¸ªæœˆ", "å¼€å§‹æ“æ§ç‰©ä»¶"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-12ä¸ªæœˆ", "å¼€å§‹å‘å±•ç‰©ä»¶å­˜åœ¨çš„æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-12ä¸ªæœˆ", "å°è¯•ç”¨å£°éŸ³ä»¥åŠåŠ¨ä½œè¡¨è¾¾"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å‘å±•æ³¨è§†çœ¼å‰äº‹ç‰©çš„èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å‘å±•è§†è§‰çš„è¿½è§†èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å‘å±•è§†è§‰çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å‘å±•å¯¹å£°éŸ³çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å‘å±•å¯¹å‘³é“çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "èƒ½è¾¨åˆ«æ¥è‡ªè‡ªå·±èº«ä½“çš„æ„Ÿè§‰"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å¼€å§‹å‘å±•ç‰©ä»¶ä¸å˜çš„æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "è®¤è¯†ä¸è‡ªå·±æœ‰å…³çš„äº‹ç‰©"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å­¦ä¼šå¸¸ç”¨ç‰©ä»¶çš„åç§°ä»¥åŠåŠŸç”¨"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å­¦ä¼šç®€å•çš„ç±»åˆ«æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å­¦ä¼šç®€å•å› æœå…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "å­¦ä¹ ç‰©ä»¶åœ¨ç©ºé—´ä¸Šçš„ä½ç½®åŠå…ˆåæ¬¡åº"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "1-2å²", "ä¼šä½¿ç”¨å·¥å…·è§£å†³ç©ºé—´é—®é¢˜"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "å‘å±•å¯¹è§†è§‰åˆºæ¿€çš„ä¸“æ³¨åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "å‘å±•å¯¹è§†è§‰åˆºæ¿€çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "å‘å±•å¯¹å£°éŸ³çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "è¾¨åˆ«æ¥è‡ªèº«ä½“çš„æ„Ÿè§‰"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "å‘å±•å°†ç‰©ä»¶ç¬¦å·åŒ–çš„èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "è®¤è¯†ç‰©ä»¶çš„ç‰¹æ€§"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "çŸ¥é“ç‰©ä»¶ä¸ç‰©ä»¶ä¹‹é—´çš„å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "å‘å±•è¿›ä¸€æ­¥çš„åˆ†ç±»æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "ç†è§£äº‹æƒ…æˆ–åŠ¨ä½œä¸Šçš„å…ˆåæ¬¡åº"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "æ˜ç™½ç›¸å¯¹æ€§çš„æ¦‚å¿µåŠè¯è¯­"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "2-3å²", "æ˜ç™½ç®€å•çš„æ•°é‡æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "å‘å±•å¯¹è§†è§‰åˆºæ¿€çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "å‘å±•å¯¹å¬è§‰åˆºæ¿€çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "é€æ¸è®¤è¯†èº«ä½“çš„ä¸åŒæ„Ÿè§‰"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "è®¤è¯†æ›´æ·±å…¥çš„ç‰©ä»¶ç‰¹æ€§"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "èƒ½æ¸…æ¥šæŒæ¡ä»¥åŠè¡¨è¾¾ä¸ªåˆ«ç‰©ä»¶çš„ç”¨é€”"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "å¼€å§‹å­¦ä¹ æŠ½è±¡çš„åˆ†ç±»æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "ç†è§£äº‹æƒ…çš„å…ˆåæ¬¡åº"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "ç†è§£äº‹ç‰©ä¹‹é—´çš„ç›¸äº’å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "ç†è§£ç‰©ä»¶ä¹‹é—´åœ¨ç©ºé—´ä¸Šçš„å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "å¼€å§‹å­¦ä¹ æ•°å­—åŠå…¶æ„ä¹‰"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "å­¦ä¹ æ•°é‡çš„æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "3-4å²", "æ˜ç™½æ¯”è¾ƒçš„æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "å‘å±•å¯¹è§†è§‰åˆºæ¿€çš„ä¸“æ³¨åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "å‘å±•å¯¹è¾ƒå¤æ‚çš„è§†è§‰åˆºæ¿€çš„è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "å‘å±•æ›´ç»†è‡´çš„å¬è§‰è¾¨åˆ«èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "ç†è§£æ›´ç»†å¾®æˆ–æ›´æŠ½è±¡çš„ç‰©ä»¶å±æ€§åŠå±æ€§é—´çš„å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "èƒ½ç†è§£ç‰©ä»¶ä¹‹é—´ç›¸ä¼¼ä¹‹å¤„åŠå…±åŒä¹‹å¤„"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "æ˜ç™½æŠ½è±¡çš„ç±»åˆ«"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "å­¦ä¹ æ•°å­—ä¸æ•°é‡çš„å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "ç†è§£æ›´æœ‰å±‚æ¬¡åŠæŠ½è±¡çš„ç›¸å¯¹æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "4-5å²", "å‘å±•å¯¹äº‹ç‰©çš„è®°å¿†èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "ç†è§£åŠä½¿ç”¨ç‰©ä»¶çš„å¤šæ–¹é¢å±æ€§åŠä¸åŠ¨ä½œçš„å…³è”"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "å‘å±•å°†ç‰©ä»¶ç¬¦å·åŒ–åŠé˜…è¯»èƒ½åŠ›"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "å‘å±•ç‰©ä»¶ç±»åˆ«çš„æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "èƒ½ç†è§£ç›¸å¯¹æ€§çš„ç©ºé—´æ¦‚å¿µ"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "å°†æ‰€å­¦çš„å› æœå…³ç³»ä½œä¸ºæ€è€ƒæ—¶çš„ä¾æ®"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "å­¦ä¹ æ•°å­—ä¸æ•°é‡çš„å…³ç³»"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "èƒ½åšç®€å•çš„è¿ç®—"),
    ("è®¤çŸ¥å‘å±•ç¯‡", "5-6å²", "é“å¾·è§‚å¿µ"),

    # ---------------- è¯­è¨€è¡¨è¾¾ç¯‡ ----------------
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-12ä¸ªæœˆ", "å­¦ä¹ å‘å‡ºä¸åŒçš„å£°éŸ³"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-12ä¸ªæœˆ", "å­¦ä¹ ä½¿ç”¨å£°éŸ³æˆ–å­—è¯ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "1-2å²", "å­¦ä¹ æ¨¡ä»¿å‘å‡ºä¸åŒçš„å£°éŸ³"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "1-2å²", "å­¦ä¹ ä½¿ç”¨å•è¯ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "2-3å²", "å‘å±•å¯¹å£°éŸ³åŠå­—è¯çš„è®°å¿†åŠ›"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "2-3å²", "å­¦ä¹ ä½¿ç”¨ä¸åŒçš„è¯æ±‡"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "2-3å²", "ä½¿ç”¨2â€”3ä¸ªè¯çš„çŸ­å¥ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "2-3å²", "å¼€å§‹å­¦ä¹ ä½¿ç”¨é—®å¥"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-4å²", "å‘å±•å¯¹äº‹ç‰©çš„è®°å¿†åŠè¡¨è¾¾èƒ½åŠ›"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-4å²", "ä½¿ç”¨3ä¸ªè¯æˆ–ä»¥ä¸Šçš„å¥å­ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-4å²", "å­¦ä¹ ä½¿ç”¨å…¶ä»–è¯­æ°”ååŠ©è¯­è¨€è¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-4å²", "å­¦ä¹ ä½¿ç”¨å«æœ‰ç–‘é—®è¯çš„é—®å¥"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "3-4å²", "å­¦ä¹ ä½¿ç”¨ä»£åè¯"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "4-5å²", "å‘å±•å¯¹äº‹ç‰©çš„è®°å¿†åŠè¡¨è¾¾èƒ½åŠ›"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "4-5å²", "ä½¿ç”¨3ä¸ªè¯æˆ–ä»¥ä¸Šçš„å¥å­ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "4-5å²", "ä½¿ç”¨è¾ƒå¤æ‚çš„å¥å­ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "4-5å²", "å‘éŸ³èƒ½åŠ›åŠéŸ³è°ƒçš„å‘å±•"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "5-6å²", "å‘å±•å¯¹äº‹ç‰©çš„è®°å¿†åŠè¡¨è¾¾èƒ½åŠ›"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "5-6å²", "å¯¹æŠ½è±¡æ€§è¯æ±‡çš„ç†è§£åŠä½¿ç”¨"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "5-6å²", "èƒ½ä½¿ç”¨è¾ƒå¤æ‚çš„å¥å­ä½œè¡¨è¾¾"),
    ("è¯­è¨€è¡¨è¾¾ç¯‡", "5-6å²", "å­¦ä¹ ä½¿ç”¨é—®å¥æ¥å¢è¿›çŸ¥è¯†"),

    # ---------------- è¯­è¨€ç†è§£ç¯‡ ----------------
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "å¼€å§‹è¾¨åˆ«å£°éŸ³ä»¥åŠåšå‡ºååº”"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "å¼€å§‹å‘å±•å¯¹äººæˆ–ç‰©ä»¶çš„ä¸“æ³¨åŠ›"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "å¼€å§‹å‘å±•å¯¹ç¯å¢ƒçš„ç†è§£"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "å¯¹åå­—çš„ç†è§£åŠååº”"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "ç†è§£å•è¯ä»¥åŠå•è¯æŒ‡ä»¤"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-12ä¸ªæœˆ", "ç†è§£ç®€å•è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "1-2å²", "å‘å±•å¯¹æœ‰è¶£äº‹ç‰©çš„ä¸“æ³¨åŠ›"),
    ("è¯­è¨€ç†è§£ç¯‡", "1-2å²", "å‘å±•è½®æµè¿è½¬çš„èƒ½åŠ›"),
    ("è¯­è¨€ç†è§£ç¯‡", "1-2å²", "èƒ½ç†è§£æœ‰å…³è‡ªå·±ä»¥åŠç‰©ä»¶çš„å•è¯"),
    ("è¯­è¨€ç†è§£ç¯‡", "1-2å²", "ç†è§£ç®€å•çš„åŒè¯æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "2-3å²", "ç»§ç»­å‘å±•å¯¹å•è¯çš„ç†è§£"),
    ("è¯­è¨€ç†è§£ç¯‡", "2-3å²", "ç†è§£è¿ä¸²æˆ–å¤åˆçš„è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-4å²", "ç†è§£åŒè¯æˆ–3ä¸ªè¯ä»¥ä¸Šçš„è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-4å²", "ç†è§£è¿ä¸²æˆ–å¤åˆçš„è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "3-4å²", "ç†è§£ä»¥åŠè§£ç­”é—®é¢˜"),
    ("è¯­è¨€ç†è§£ç¯‡", "4-5å²", "ç†è§£åŒè¯æˆ–3ä¸ªè¯ä»¥ä¸Šçš„è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),
    ("è¯­è¨€ç†è§£ç¯‡", "4-5å²", "èƒ½ç†è§£è¿ä¸²æˆ–å¤åˆçš„è¯­è¨€æŒ‡ä»¤æˆ–å¥å­"),

    # ---------------- å°è‚Œè‚‰å‘å±•ç¯‡ ----------------
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "6-12ä¸ªæœˆ", "å­¦ä¹ æ§åˆ¶è‡ªå·±çš„èº«ä½“"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "6-12ä¸ªæœˆ", "å¼€å§‹æ‰§ç¬”"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›æ‰§ç¬”ä¹¦å†™æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›æ‹¾æ”¾æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›ç©å…·æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›æ‹¼ç ŒæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¢è¿›æŸ±æ¡æ’æ”¾æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "å¢è¿›æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "å¢è¿›ä¸²è¿æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "å¢è¿›å†™ç”»æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "å¢è¿›æ‹¼ç ŒæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "å¢è¿›ä¸²è¿æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "å¢è¿›å†™ç”»æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "å¢è¿›æ‹¼ç ŒæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "å¢è¿›å‰ªåˆ€æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "å¢è¿›æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "å¢è¿›ä¸²è¿æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "å¢è¿›å†™ç”»æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "å¢è¿›æŠ˜çº¸æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "è®­ç»ƒç§¯æœ¨å †ç ŒæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "è®­ç»ƒå›¾å·¥æŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "è®­ç»ƒè§¦è§‰èƒ½åŠ›"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "5-6å²", "å‰ªåˆ€æ“ä½œ"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "5-6å²", "æ“ä½œæŠ€èƒ½"),
    ("å°è‚Œè‚‰å‘å±•ç¯‡", "5-6å²", "å†™ç”»æŠ€èƒ½"),

    # ---------------- å¤§è‚Œè‚‰å‘å±•ç¯‡ ----------------
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "å¹³è¡¡èƒ½åŠ›"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "æŠ›æ¥æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "æŒç‰©æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "ä¸Šä¸‹æ¥¼æ¢¯"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "è·³è·ƒæŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "1-2å²", "æ¨æ‹‰æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "å¹³è¡¡èƒ½åŠ›"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "çƒç±»æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "ä¸Šä¸‹æ¥¼æ¢¯"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "2-3å²", "è·³è·ƒæŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "æ‘‡è¡"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "å¹³è¡¡æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "æŠ›æ¥æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "ä¸Šä¸‹æ¥¼æ¢¯"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "3-4å²", "è·³è·ƒæŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "å¹³è¡¡èƒ½åŠ›"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "è·³è·ƒæŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "4-5å²", "æŠ›æ¥æŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "5-6å²", "è·³è·ƒæŠ€èƒ½"),
    ("å¤§è‚Œè‚‰å‘å±•ç¯‡", "5-6å²", "çƒç±»æŠ€èƒ½"),

    # ---------------- æ¨¡ä»¿å‘å±•ç¯‡ ----------------
    ("æ¨¡ä»¿å‘å±•ç¯‡", "5-12ä¸ªæœˆ", "èƒ½æ¨¡ä»¿ç®€å•æ“å¼„ç‰©ä»¶çš„æ–¹æ³•"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "5-12ä¸ªæœˆ", "èƒ½æ¨¡ä»¿å‘å‡ºä¸€äº›è‡ªå·±èƒ½å‘å‡ºçš„ç®€å•å£°éŸ³"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "5-12ä¸ªæœˆ", "èƒ½æ¨¡ä»¿ä¸€äº›ä¸ç†Ÿæ‚‰çš„å£°éŸ³"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "1-2å²", "èƒ½æ¨¡ä»¿ç®€å•åŠ¨ä½œ"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "1-2å²", "æ¨¡ä»¿ä½¿ç”¨å¸¸ç”¨ç‰©ä»¶"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "1-2å²", "æ¨¡ä»¿è¯´å‡ºå­—è¯"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "1-2å²", "æ¨¡ä»¿è¾ƒå¤æ‚çš„éè¯­è¨€æ€§å£°éŸ³"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "2-3å²", "æ¨¡ä»¿è¾ƒå¤æ‚çš„è¿ä¸²åŠ¨ä½œ"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "2-3å²", "æ¨¡ä»¿ä½¿ç”¨ç‰©ä»¶è¿›è¡Œè¾ƒå¤æ‚çš„æ´»åŠ¨"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "2-3å²", "èƒ½æ¨¡ä»¿è¯´å‡ºè¯è¯­æˆ–çŸ­å¥"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "3-4å²", "èƒ½æ¨¡ä»¿ç²¾ç»†çš„èº«ä½“åŠ¨ä½œ"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "3-4å²", "èƒ½æ¨¡ä»¿ä½¿ç”¨ç‰©ä»¶ä½œè¾ƒå¤æ‚çš„æ´»åŠ¨"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "3-4å²", "èƒ½æ¨¡ä»¿è¯´å‡ºçŸ­å¥"),
    ("æ¨¡ä»¿å‘å±•ç¯‡", "4å²ä»¥ä¸Š", "èƒ½æ¨¡ä»¿è¾ƒå¤æ‚æˆ–è¿ä¸²æœ‰å…ˆåæ¬¡åºçš„åŠ¨ä½œ")
]

def find_best_match(target_name: str, threshold=0.55):
    """ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…å¯»æ‰¾æœ€æ¥è¿‘çš„ç›®å½•é¡¹"""
    best_score = 0
    best_match = None
    
    for module, age, toc_name in TOC_DATA:
        # è®¡ç®—å­—ç¬¦ä¸²ç›¸ä¼¼åº¦
        score = difflib.SequenceMatcher(None, target_name, toc_name).ratio()
        
        # é¢å¤–åŠ åˆ†é¡¹ï¼šäº’ç›¸åŒ…å«ï¼Œç›¸ä¼¼åº¦å¤§å¹…æå‡
        if target_name in toc_name or toc_name in target_name:
            score += 0.35 
            
        if score > best_score:
            best_score = score
            best_match = (module, age, toc_name)
            
    if best_score >= threshold:
        return best_match, best_score
    return None, 0

def main():
    if not os.path.exists(QUEST_TTL_PATH):
        print(f"âŒ æ‰¾ä¸åˆ°å›¾è°±: {QUEST_TTL_PATH}")
        return

    g = Graph()
    g.parse(QUEST_TTL_PATH, format="turtle")
    g.bind("ecta-kg", ECTA_KG)
    
    macros = list(g.subjects(RDF.type, ECTA_KG.MacroObjective))
    updated_count = 0
    
    print(f"ğŸš€ å¯åŠ¨ç»ˆææ™ºèƒ½æ‰«æ (å…± {len(macros)} ä¸ªç›®æ ‡)...\n")

    for macro_uri in macros:
        labels = list(g.objects(macro_uri, RDFS.label))
        if not labels:
            continue
            
        macro_name = str(labels[0]).strip()
        match, score = find_best_match(macro_name)
        
        if match:
            module, age, toc_name = match
            
            # æ¸…ç†æ—§å±æ€§å¹¶æ‰“ä¸Šæ–°å±æ€§ (åŒ…å«æ‰€å±æ¨¡å—!)
            g.remove((macro_uri, ECTA_KG.recommendedAgeBracket, None))
            g.remove((macro_uri, ECTA_KG.belongsToModule, None))
            g.add((macro_uri, ECTA_KG.recommendedAgeBracket, Literal(age)))
            g.add((macro_uri, ECTA_KG.belongsToModule, Literal(module)))
            
            updated_count += 1
            print(f"âœ… [å¾—åˆ† {score:.2f}] ã€Š{macro_name}ã€‹")
            print(f"   â†³ æ˜ å°„è‡³: ã€{module}ã€‘ | {age} | {toc_name}\n")

    g.serialize(destination=QUEST_TTL_PATH, format="turtle")
    print(f"ğŸ‰ å…¨ä¹¦ç›®å½•æ‰«æå®Œæˆï¼ç›®å‰å…±æˆåŠŸç²¾å‡†æ˜ å°„ {updated_count} ä¸ªå®è§‚ä»»åŠ¡ã€‚")

if __name__ == "__main__":
    main()
